<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Sistema de controle de vendas Ice Beer">
    <title>üç∫ Ice Beer - Sistema de Vendas v4.0</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ice Beer">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTYiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyMCAyNC42ODYzIDIyLjY4NjMgMjIgMjYgMjJINDZDNDkuMzEzNyAyMiA1MiAyNC42ODYzIDUyIDI4VjQ0QzUyIDQ3LjMxMzcgNDkuMzEzNyA1MCA0NiA1MEgyNkMyMi42ODYzIDUwIDIwIDQ3LjMxMzcgMjAgNDRWMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Progress Indicator -->
    <div id="progressIndicator" class="progress-indicator">
        <div id="progressBar" class="progress-indicator-bar"></div>
    </div>

    <!-- Status Indicators -->
    <div class="status-indicators">
        <div id="firebaseStatus" class="status-indicator">üî• Conectando Firebase...</div>
        <div id="cacheStatus" class="status-indicator">üíæ Inicializando Cache...</div>
        <div id="pwStatus" class="status-indicator">üì± Configurando PWA...</div>
    </div>

    <!-- Performance Indicator -->
    <div id="performanceIndicator" class="performance-indicator">‚ö° Carregando...</div>

    <!-- Cache Status -->
    <div id="cacheStatusDisplay" class="cache-status" onclick="showCacheStats()">
        üíæ Cache: Carregando...
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="card">
            <div class="header">
                <h1>üç∫ Ice Beer</h1>
                <p>Sistema de Controle de Vendas</p>
                <div class="version-badge">v4.0</div>
            </div>
            
            <div class="login-form">
                <div id="loginAlert" class="alert alert-error hidden"></div>
                
                <div class="form-group">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" placeholder="seu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" placeholder="Sua senha" required>
                </div>
                
                <button id="loginBtn" onclick="handleLogin()">
                    <span id="loginText">Entrar</span>
                    <span id="loginLoading" class="loading hidden"></span>
                </button>
            </div>
        </div>

        <!-- Dashboard Principal -->
        <div id="dashboard" class="dashboard">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="user-info">
                    <h2 id="welcomeText">Carregando...</h2>
                    <span id="currentDate"></span>
                </div>
                <div class="top-controls">
                    <select id="monthYearSelect" onchange="handleUpdateDashboard()">
                        <option value="">Carregando...</option>
                    </select>
                    <button class="logout-btn" onclick="handleLogout()">Sair</button>
                </div>
            </div>

            <!-- Filtros Avan√ßados -->
            <div class="filters-panel">
                <div class="filters-title">
                    üìä Filtros Avan√ßados
                    <span class="tooltip" data-tooltip="Use os filtros para an√°lises personalizadas">‚ÑπÔ∏è</span>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="filterSegment">Segmento:</label>
                        <select id="filterSegment" onchange="handleSegmentChange()">
                            <option value="">Todos os segmentos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStore">Loja:</label>
                        <select id="filterStore" onchange="handleStoreChange()">
                            <option value="">Todas as lojas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterMonth">M√™s/Ano:</label>
                        <select id="filterMonth" onchange="handleMonthChange()">
                            <option value="">Selecione um m√™s</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterPeriod">Per√≠odo:</label>
                        <select id="filterPeriod" onchange="handlePeriodChange()">
                            <option value="">Todo o m√™s</option>
                            <option value="week">Por semana</option>
                            <option value="range">Per√≠odo personalizado</option>
                        </select>
                    </div>
                </div>

                <!-- Filtros de Data Personalizados -->
                <div id="customDateRange" class="custom-date-range hidden">
                    <div class="date-inputs">
                        <div class="form-group">
                            <label for="startDate">Data In√≠cio:</label>
                            <input type="date" id="startDate" onchange="handleDateRangeChange()">
                        </div>
                        <div class="form-group">
                            <label for="endDate">Data Fim:</label>
                            <input type="date" id="endDate" onchange="handleDateRangeChange()">
                        </div>
                    </div>
                </div>

                <!-- Filtro de Semanas -->
                <div id="weekFilter" class="week-filter hidden">
                    <div class="form-group">
                        <label for="filterWeek">Semana:</label>
                        <select id="filterWeek" onchange="handleWeekChange()">
                            <option value="">Todas as semanas</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="analyze-btn" id="analyzeBtn" onclick="handleAnalyze()">
                        <span id="analyzeText">üìà Analisar</span>
                        <span id="analyzeLoading" class="loading hidden"></span>
                    </button>
                    <button class="analyze-btn secondary" onclick="clearFilters()">
                        üîÑ Limpar Filtros
                    </button>
                </div>
            </div>

            <!-- Estat√≠sticas Principais -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">R$ 0,00</div>
                    <div class="stat-label">Faturamento Total</div>
                    <div class="stat-subtitle" id="revenueInfo">Per√≠odo selecionado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="averageDaily">R$ 0,00</div>
                    <div class="stat-label">M√©dia Di√°ria</div>
                    <div class="stat-subtitle" id="dailyInfo">Baseada no per√≠odo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="projectionMonthly">R$ 0,00</div>
                    <div class="stat-label">Proje√ß√£o Mensal</div>
                    <div class="stat-subtitle" id="projectionInfo">Com base na m√©dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="goalProgress">0%</div>
                    <div class="stat-label">% da Meta</div>
                    <div class="stat-subtitle" id="goalInfo">Meta vs Realizado</div>
                </div>
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="card">
                <h3 class="section-title">üõ†Ô∏è A√ß√µes e Relat√≥rios</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="generateDetailedReport()">
                        üìÑ Relat√≥rio Detalhado
                    </button>
                    <button class="action-btn secondary" onclick="exportToExcel()">
                        üìä Exportar Excel
                    </button>
                    <button class="action-btn" onclick="showChartsModal()">
                        üìà Gr√°ficos Avan√ßados
                    </button>
                    <button class="action-btn secondary" onclick="backupData()">
                        üíæ Backup
                    </button>
                </div>
            </div>

            <!-- Formul√°rios -->
            <div class="forms-section">
                <!-- Lan√ßamento de Vendas -->
                <div class="card">
                    <h3 class="section-title">üìä Lan√ßar Vendas</h3>
                    <div id="entryAlert" class="alert alert-success hidden"></div>
                    
                    <div class="form-group">
                        <label for="storeSelect">Loja:</label>
                        <select id="storeSelect" required>
                            <option value="">Selecione uma loja</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryType">Tipo de Lan√ßamento:</label>
                        <select id="entryType" onchange="handleEntryTypeChange()" required>
                            <option value="single">Dia espec√≠fico</option>
                            <option value="period">Per√≠odo (m√∫ltiplos dias)</option>
                            <option value="week">Semana completa</option>
                        </select>
                    </div>

                    <!-- Campos de data flex√≠veis -->
                    <div id="singleDateField" class="form-group">
                        <label for="singleDate">Data:</label>
                        <input type="date" id="singleDate" onchange="previewTargetMonth()">
                    </div>

                    <div id="periodFields" class="period-fields hidden">
                        <div class="form-group">
                            <label for="periodStart">Data In√≠cio:</label>
                            <input type="date" id="periodStart" onchange="previewTargetMonth()">
                        </div>
                        <div class="form-group">
                            <label for="periodEnd">Data Fim:</label>
                            <input type="date" id="periodEnd" onchange="previewTargetMonth()">
                        </div>
                    </div>
                    
                    <div id="monthPreview" class="month-preview hidden">
                        <span id="monthPreviewText"></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryValue">Faturamento (R$):</label>
                        <input type="number" id="entryValue" placeholder="0,00" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryNotes">Observa√ß√µes (opcional):</label>
                        <textarea id="entryNotes" placeholder="Adicione observa√ß√µes sobre este lan√ßamento" rows="3"></textarea>
                    </div>
                    
                    <button id="entryBtn" onclick="handleSubmitSales()">
                        <span id="entryText">Lan√ßar Vendas</span>
                        <span id="entryLoading" class="loading hidden"></span>
                    </button>
                    
                    <div id="editMode" class="edit-mode hidden">
                        <p>üîÑ Modo de Edi√ß√£o Ativo</p>
                        <button onclick="handleCancelEdit()" class="cancel-btn">Cancelar Edi√ß√£o</button>
                    </div>
                </div>

                <!-- Definir Metas -->
                <div class="card">
                    <h3 class="section-title">üéØ Definir Meta</h3>
                    <div id="targetAlert" class="alert alert-success hidden"></div>
                    
                    <div class="form-group">
                        <label for="targetStoreSelect">Loja:</label>
                        <select id="targetStoreSelect" required>
                            <option value="">Selecione uma loja</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="targetType">Tipo de Meta:</label>
                        <select id="targetType" onchange="handleTargetTypeChange()" required>
                            <option value="monthly">Meta Mensal</option>
                            <option value="weekly">Meta Semanal</option>
                            <option value="daily">Meta Di√°ria</option>
                        </select>
                    </div>

                    <div id="targetDateField" class="form-group hidden">
                        <label for="targetDate">Data/Per√≠odo:</label>
                        <input type="date" id="targetDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="targetValue">Valor da Meta (R$):</label>
                        <input type="number" id="targetValue" placeholder="0,00" step="0.01" min="0" required>
                    </div>
                    
                    <button id="targetBtn" onclick="handleSetTarget()">
                        <span id="targetText">Salvar Meta</span>
                        <span id="targetLoading" class="loading hidden"></span>
                    </button>
                </div>
            </div>

            <!-- Tabela de Resultados -->
            <div class="card">
                <h3 class="section-title">üìà Resultados - <span id="selectedPeriodDisplay">Per√≠odo Atual</span></h3>
                
                <!-- Controles da Tabela -->
                <div class="table-controls">
                    <div class="view-options">
                        <button class="view-btn active" onclick="switchView('stores')" id="storesViewBtn">Por Loja</button>
                        <button class="view-btn" onclick="switchView('timeline')" id="timelineViewBtn">Timeline</button>
                        <button class="view-btn" onclick="switchView('comparison')" id="comparisonViewBtn">Comparativo</button>
                    </div>
                    <div class="table-actions">
                        <button class="btn-small" onclick="exportTableData()">üìä Exportar</button>
                        <button class="btn-small" onclick="refreshTableData()">üîÑ Atualizar</button>
                    </div>
                </div>

                <!-- Tabela por Lojas -->
                <div id="storesView" class="table-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Loja</th>
                                <th>Faturamento</th>
                                <th>Meta</th>
                                <th>% Atingido</th>
                                <th>M√©dia Di√°ria</th>
                                <th>Lan√ßamentos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="storesTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Timeline de Lan√ßamentos -->
                <div id="timelineView" class="table-view hidden">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Loja</th>
                                <th>Per√≠odo</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                                <th>Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="timelineTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">Carregando timeline...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Vista Comparativa -->
                <div id="comparisonView" class="table-view hidden">
                    <div class="comparison-charts">
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notification" class="notification">
        <button class="notification-close" onclick="closeNotification()">&times;</button>
        <div class="notification-title" id="notificationTitle">T√≠tulo</div>
        <div class="notification-message" id="notificationMessage">Mensagem</div>
    </div>

    <!-- Modal para Gr√°ficos -->
    <div id="chartsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìä An√°lise Detalhada</h3>
                <button class="modal-close" onclick="closeChartsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="charts-container">
                    <div class="chart-section">
                        <h4>Evolu√ß√£o Temporal</h4>
                        <canvas id="timelineChart"></canvas>
                    </div>
                    <div class="chart-section">
                        <h4>Performance por Loja</h4>
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="chart-section">
                        <h4>Metas vs Realizado</h4>
                        <canvas id="goalsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <div>
            <strong>üç∫ Instalar Ice Beer</strong><br>
            <small>Acesse rapidamente do seu dispositivo!</small>
        </div>
        <button onclick="installPWA()">Instalar</button>
        <button onclick="dismissInstallPrompt()">Agora n√£o</button>
    </div>

    <!-- Scripts -->
    <script type="module" src="script.js"></script>
</body>
</html>