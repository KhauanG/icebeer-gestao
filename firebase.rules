rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===============================
    // FUNÇÕES AUXILIARES
    // ===============================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAuthorizedUser() {
      return isAuthenticated() && 
        request.auth.token.email in [
          'conveniencias@icebeer.com',
          'petiscarias@icebeer.com', 
          'diskchopp@icebeer.com',
          'executivo@icebeer.com'
        ];
    }
    
    function getUserSegment() {
      return request.auth.token.email == 'conveniencias@icebeer.com' ? 'conveniencias' :
             request.auth.token.email == 'petiscarias@icebeer.com' ? 'petiscarias' :
             request.auth.token.email == 'diskchopp@icebeer.com' ? 'diskchopp' :
             request.auth.token.email == 'executivo@icebeer.com' ? 'executive' : null;
    }
    
    function isExecutive() {
      return request.auth.token.email == 'executivo@icebeer.com';
    }
    
    function hasSegmentAccess(segment) {
      return isExecutive() || getUserSegment() == segment;
    }
    
    function isValidStore(segment, store) {
      return (segment == 'conveniencias' && store in ['Loja 1', 'Loja 2', 'Loja 3']) ||
             (segment == 'petiscarias' && store in ['Loja 1', 'Loja 2']) ||
             (segment == 'diskchopp' && store in ['Delivery']);
    }
    
    function isValidDateRange(dateValue) {
      let startLimit = timestamp.date(2025, 6, 1);
      let endLimit = timestamp.date(2028, 12, 31);
      return dateValue >= startLimit && dateValue <= endLimit;
    }
    
    function isValidMonth(month) {
      return month.matches('202[5-8]-(0[6-9]|1[0-2])') || 
             month.matches('202[6-8]-(0[1-9]|1[0-2])');
    }
    
    // Validação mais flexível para vendas
    function validateSalesEntry(data) {
      return data.keys().hasAll(['segment', 'store', 'value', 'entryDate', 'month', 'entryType', 'user']) &&
             data.segment is string && data.segment in ['conveniencias', 'petiscarias', 'diskchopp'] &&
             data.store is string &&
             data.value is number && data.value > 0 && data.value <= 1000000 &&
             data.entryDate is timestamp &&
             data.month is string &&
             data.entryType is string && data.entryType in ['single', 'period', 'week'] &&
             data.user is string && data.user == request.auth.token.email;
    }
    
    // Validação mais flexível para metas
    function validateTarget(data) {
      return data.keys().hasAll(['segment', 'store', 'month', 'type', 'value', 'user']) &&
             data.segment is string && data.segment in ['conveniencias', 'petiscarias', 'diskchopp'] &&
             data.store is string &&
             data.month is string &&
             data.type is string && data.type in ['monthly', 'weekly', 'daily'] &&
             data.value is number && data.value > 0 && data.value <= 10000000 &&
             data.user is string && data.user == request.auth.token.email;
    }
    
    function validateSystemLog(data) {
      return data.keys().hasAll(['timestamp', 'level', 'message', 'user']) &&
             data.level in ['info', 'warning', 'error', 'debug'] &&
             data.user == request.auth.token.email;
    }
    
    // ===============================
    // SALES_ENTRIES - Lançamentos de Vendas
    // ===============================
    
    match /sales_entries/{entryId} {
      allow read: if isAuthorizedUser();
      
      allow create: if isAuthorizedUser() && 
                       validateSalesEntry(request.resource.data);
      
      allow update: if isAuthorizedUser() &&
                       validateSalesEntry(request.resource.data);
      
      allow delete: if isAuthorizedUser();
    }
    
    // ===============================
    // TARGETS - Metas (Regras Simplificadas)
    // ===============================
    
    match /targets/{targetId} {
      allow read: if isAuthorizedUser();
      
      allow create: if isAuthorizedUser() &&
                      validateTarget(request.resource.data);
      
      allow update: if isAuthorizedUser() &&
                      validateTarget(request.resource.data);
      
      allow delete: if isAuthorizedUser();
    }
    
    // ===============================
    // USER_PROFILES - Perfis de Usuário
    // ===============================
    
    match /user_profiles/{userId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // ===============================
    // SYSTEM_LOGS - Logs do Sistema
    // ===============================
    
    match /system_logs/{logId} {
      allow read: if isAuthorizedUser();
      
      allow create: if isAuthorizedUser() && validateSystemLog(request.resource.data);
    }
    
    // ===============================
    // SYSTEM_SETTINGS - Configurações
    // ===============================
    
    match /system_settings/{settingId} {
      allow read: if isAuthorizedUser();
      
      allow write: if isAuthorizedUser();
    }
    
    // ===============================
    // NOTIFICATIONS - Notificações
    // ===============================
    
    match /notifications/{notificationId} {
      allow read: if isAuthorizedUser();
      
      allow create: if isAuthorizedUser();
      
      allow update: if isAuthorizedUser();
      
      allow delete: if isAuthorizedUser();
    }
    
    // ===============================
    // OFFLINE_QUEUE - Fila Offline
    // ===============================
    
    match /offline_queue/{queueId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // ===============================
    // REPORTS - Relatórios
    // ===============================
    
    match /reports/{reportId} {
      allow read: if isAuthorizedUser();
      
      allow create: if isAuthorizedUser();
      
      allow update: if isAuthorizedUser();
      
      allow delete: if isAuthorizedUser();
    }
    
    // ===============================
    // CACHE_INVALIDATION - Controle de Cache
    // ===============================
    
    match /cache_invalidation/{cacheId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // ===============================
    // BACKUP_DATA - Dados de Backup
    // ===============================
    
    match /backup_data/{backupId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // ===============================
    // SAMPLE_DATA - Dados de Exemplo (Para Auto Setup)
    // ===============================
    
    match /sample_data/{docId} {
      allow read, write: if isAuthorizedUser();
    }
    
    // ===============================
    // INITIALIZATION - Inicialização do Sistema
    // ===============================
    
    match /initialization/{docId} {
      allow read, write: if isAuthorizedUser();
    }
  }
}